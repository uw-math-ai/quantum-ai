import stim
import numpy as np

stabilizers = [
    "XXXXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIXXXXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIXXXXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIXXXXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIXXXXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXXXXIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXXXXIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXXXXIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXXXXIII",
    "XIXIXIXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIXIXIXIXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIXIXIXIXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIXIXIXIXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIXIXIXIXIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXIXIXIXIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXIXIXIXIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXIXIXIXIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXIXIXIX",
    "IIXXXXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIXXXXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIXXXXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIXXXXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXXXXIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXXXXIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXXXXIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXXXXIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXXXXI",
    "ZZZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIZZZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIZZZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIZZZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIZZZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZZZIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZZZIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZZZIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZZZIII",
    "ZIZIZIZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIZIZIZIZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIZIZIZIZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIZIZIZIZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIZIZIZIZIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZIZIZIZIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZIZIZIZIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZIZIZIZIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZIZIZIZ",
    "IIZZZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIZZZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIZZZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIZZZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZZZIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZZZIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZZZIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZZZIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZZZI",
    "IXXIXIIIXXIXIIIIIIIIIIXXIXIIIXXIXIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIXXIXIIIXXIXIIIIIIIIIIXXIXIIIXXIXII",
    "IIIIIIIIIIIIIIIXXIXIIIIIIIIIIIIIIIIIXXIXIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIXXIXIIIIIIIIIIIIIIIIIXXIXIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIZZIZIIIZZIZIIIIIIIIIIZZIZIIIZZIZIIIIIIIII",
    "IIIIIIIIZZIZIIIZZIZIIIIIIIIIIZZIZIIIZZIZIIIIIIIIIIIIIIIIIIIIIII",
    "IZZIZIIIZZIZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
    "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZIZIIIZZIZII"
]
stabilizers = [s.strip() for s in stabilizers]
N = 63

def to_binary_vector(s):
    xs = [1 if c in 'XY' else 0 for c in s]
    zs = [1 if c in 'YZ' else 0 for c in s]
    return xs + zs

def to_pauli_string(vec):
    n = len(vec) // 2
    s = []
    for i in range(n):
        x = vec[i]
        z = vec[n+i]
        if x and z: s.append("Y")
        elif x: s.append("X")
        elif z: s.append("Z")
        else: s.append("I")
    return "".join(s)

matrix = np.array([to_binary_vector(s) for s in stabilizers], dtype=int)
print(f"Matrix shape: {matrix.shape}")

Hx = matrix[:, :N]
Hz = matrix[:, N:]
A = np.hstack([Hz, Hx]) # A * [vx, vz]^T = 0
print(f"A shape: {A.shape}")

def gf2_rref(mat):
    m, n = mat.shape
    mat = mat.copy()
    pivot_cols = []
    r = 0
    for c in range(n):
        if r >= m: break
        # Find pivot
        pivot_row = -1
        for i in range(r, m):
            if mat[i, c] == 1:
                pivot_row = i
                break
        
        if pivot_row != -1:
            # Swap
            mat[[r, pivot_row]] = mat[[pivot_row, r]]
            pivot_cols.append(c)
            # Eliminate
            for i in range(m):
                if i != r and mat[i, c] == 1:
                    mat[i] ^= mat[r]
            r += 1
    return mat, pivot_cols, r

rref_A, pivots, rank = gf2_rref(A)
print(f"Rank of A: {rank}")

free_vars = [c for c in range(2*N) if c not in pivots]
print(f"Number of free variables: {len(free_vars)}")

# Null space basis
null_basis = []
for free in free_vars:
    vec = np.zeros(2*N, dtype=int)
    vec[free] = 1
    # Check if this free variable is involved in any pivot equations
    # For each row r in RREF (which corresponds to pivot col pivots[r])
    # x_{p_r} + sum_{k>p_r} A_{rk} x_k = 0
    for r in range(rank):
        p = pivots[r]
        # if rref_A[r, free] == 1, then x_p must flip
        if rref_A[r, free] == 1:
            vec[p] = 1
    null_basis.append(vec)

print(f"Found {len(null_basis)} basis vectors for centralizer.")

# Find independent operator
# We need an operator that is NOT generated by the stabilizers.
# Check linear independence against 'matrix'
# We can just use the same RREF function.
current_rank = 62
# Verify rank of matrix
_, _, r_stab = gf2_rref(matrix)
print(f"Rank of stabilizers: {r_stab}")

found_op = False
for i, cand in enumerate(null_basis):
    test_mat = np.vstack([matrix, cand])
    _, _, r = gf2_rref(test_mat)
    if r > r_stab:
        cand_str = to_pauli_string(cand)
        print(f"Found independent commuting operator: {cand_str}")
        
        full_stabs = stabilizers + [cand_str]
        try:
            t = stim.Tableau.from_stabilizers([stim.PauliString(s) for s in full_stabs])
            print("Tableau creation successful!")
            circuit = t.to_circuit(method="elimination")
            with open("circuit_63_v2.stim", "w") as f:
                f.write(str(circuit))
            print("Circuit written to circuit_63_v2.stim")
            found_op = True
            break
        except Exception as e:
            print(f"Stim failed validation: {e}")

if not found_op:
    print("Could not find independent operator. Something is wrong.")
