import stim
import sys

try:
    with open("circuit_49.stim", "r") as f:
        circuit_text = f.read()
    
    circuit = stim.Circuit(circuit_text)
    
    stabilizers = [
        "XXIIIIIXXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIXXIIIIIXXIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIXXIIIIIXXIIIIIIIIIIII",
        "IIIIIIIIXXIIIIIXXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIXXIIIIIXXIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXXIIIIIXXIIII",
        "IIXXIIIIIXXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIXXIIIIIXXIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXXIIIIIXXIIIIIIIIII",
        "IIIIIIIIIIXXIIIIIXXIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIXXIIIIIXXIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXXIIIIIXXII",
        "IIIIXXIIIIIXXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIXXIIIIIXXIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXXIIIIIXXIIIIIIII",
        "IIIIIIIIIIIIXXIIIIIXXIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIXXIIIIIXXIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXXIIIIIXX",
        "IIIIIIXIIIIIIXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIXIIIIIIXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIXIIIIIIXIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIXIIIIIIXIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXIIIIIIXIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXIIIIIIXIIIIII",
        "IIIIIIIZZIIIIIZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIZZIIIIIZZIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZIIIIIZZIIIII",
        "IZZIIIIIZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIZZIIIIIZZIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZIIIIIZZIIIIIIIIIII",
        "IIIIIIIIIZZIIIIIZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIZZIIIIIZZIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZIIIIIZZIII",
        "IIIZZIIIIIZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIZZIIIIIZZIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZIIIIIZZIIIIIIIII",
        "IIIIIIIIIIIZZIIIIIZZIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIZZIIIIIZZIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZIIIIIZZI",
        "IIIIIZZIIIIIZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIZZIIIIIZZIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZIIIIIZZIIIIIII",
        "ZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZIIII",
        "IIZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZII",
        "IIIIZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZZ"
    ]
    
    tableau = stim.Tableau.from_circuit(circuit)
    
    # We need to check if the state prepared by the circuit (starting from |0>)
    # is a +1 eigenstate of all stabilizers.
    # The circuit prepares a state |psi> = U|0>.
    # We want S_i |psi> = |psi> for all i.
    # This is equivalent to checking if U^dag S_i U |0> = |0>.
    # Which means U^dag S_i U must stabilize |0>.
    # The stabilizers of |0> are Z on every qubit.
    # So U^dag S_i U should be a product of Z operators (and identity).
    # stim.Tableau stores U (or U^-1?).
    # tableau(P) computes U P U^dag (conjugation).
    # Wait, Stim tableau represents the map P -> U P U^dag.
    # So if we have S_i, we want to know if it stabilizes the output state.
    # The output state is stabilized by Z_k if the k-th qubit is in |0>.
    # Actually, the tableau tells us the stabilizers of the output state.
    # The output stabilizers are the images of Z_k under U.
    # i.e. g_k = U Z_k U^dag.
    # These g_k generate the stabilizer group of the state.
    # We need to check if each S_i is in the group generated by {g_k}.
    # Alternatively, we can just use `tableau_simulator`.
    
    sim = stim.TableauSimulator()
    sim.do(circuit)
    
    all_good = True
    for s in stabilizers:
        p = stim.PauliString(s)
        # expectation_value returns +1, -1, or 0 (if random).
        # We want +1.
        ev = sim.peek_observable_expectation(p)
        if ev != 1:
            print(f"Stabilizer {s} not preserved. Expectation: {ev}")
            all_good = False
            
    if all_good:
        print("ALL STABILIZERS PRESERVED")
    else:
        print("SOME STABILIZERS FAILED")

except Exception as e:
    print(f"Error: {e}")
