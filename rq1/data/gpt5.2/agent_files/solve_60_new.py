import stim
import sys

def solve():
    stabilizers = [
        "XZZXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIXZZXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIXZZXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIXZZXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIXZZXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIXZZXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXZZXIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXZZXIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXZZXIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXZZXIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXZZXIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXZZXI",
        "IXZZXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIXZZXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIXZZXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIXZZXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIXZZXIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIXZZXIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXZZXIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXZZXIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXZZXIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXZZXIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXZZXIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXZZX",
        "XIXZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIXIXZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIXIXZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIXIXZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIXIXZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIXIXZZIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXIXZZIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXIXZZIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXIXZZIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXIXZZIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXIXZZIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXIXZZ",
        "ZXIXZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIZXIXZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIZXIXZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIZXIXZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIZXIXZIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIZXIXZIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZXIXZIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZXIXZIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZXIXZIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZXIXZIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZXIXZIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIZXIXZ",
        "XXXXXXXXXXXXXXXIIIIIIIIIIIIIIIXXXXXXXXXXXXXXXIIIIIIIIIIIIIII",
        "IIIIIIIIIIXXXXXXXXXXXXXXXIIIIIIIIIIIIIIIXXXXXXXXXXXXXXXIIIII",
        "XXXXXIIIIIIIIIIIIIIIXXXXXXXXXXXXXXXIIIIIIIIIIIIIIIXXXXXXXXXX",
        "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXIIIIIIIIIIIIIIIIIIIIIIIIIIIIII",
        "IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
        "IIIIIIIIIIZZZZZZZZZZZZZZZZZZZZIIIIIZZZZZIIIIIZZZZZIIIIIIIIII",
        "ZZZZZIIIIIIIIIIIIIIIZZZZZIIIIIZZZZZZZZZZZZZZZIIIIIIIIIIZZZZZ",
        "ZZZZZZZZZZZZZZZIIIIIIIIIIZZZZZZZZZZIIIIIIIIIIIIIIIZZZZZIIIII",
        "ZZZZZIIIIIIIIIIZZZZZZZZZZZZZZZIIIIIIIIIIZZZZZIIIIIZZZZZIIIII",
        "IIIIIZZZZZZZZZZIIIIIIIIIIIIIIIZZZZZZZZZZIIIIIZZZZZIIIIIZZZZZ"
    ]
    
    parsed_stabilizers = [stim.PauliString(s) for s in stabilizers]
    
    print(f"Loaded {len(parsed_stabilizers)} stabilizers.")

    # Check for commutativity
    def commute(s1, s2):
        return s1.commutes(s2)

    anticommuting_pairs = []
    for i in range(len(parsed_stabilizers)):
        for j in range(i + 1, len(parsed_stabilizers)):
            if not commute(parsed_stabilizers[i], parsed_stabilizers[j]):
                anticommuting_pairs.append((i, j))
    
    print(f"Anticommuting pairs: {len(anticommuting_pairs)}")
    if len(anticommuting_pairs) > 0:
        print("First 10 pairs:", anticommuting_pairs[:10])
        # We can't proceed with Stim if they anticommute, unless we drop some.
        # But let's see if we can just form the tableau anyway (it might fail).
    
    try:
        tableau = stim.Tableau.from_stabilizers(parsed_stabilizers, allow_redundant=True, allow_underconstrained=True)
        print("Tableau created successfully.")
    except Exception as e:
        print(f"Error creating tableau: {e}")
        return

    # Convert to circuit
    circuit = tableau.to_circuit("elimination")
    
    # Verify
    sim = stim.TableauSimulator()
    sim.do(circuit)
    
    all_good = True
    preserved_count = 0
    for i, s in enumerate(parsed_stabilizers):
        exp = sim.peek_observable_expectation(s)
        if exp != 1:
            print(f"Stabilizer {i} not preserved. Expectation: {exp}")
            all_good = False
        else:
            preserved_count += 1
            
    print(f"Preserved {preserved_count}/{len(parsed_stabilizers)} stabilizers.")
    
    if all_good:
        print("All stabilizers preserved.")
        with open("circuit_60_new.stim", "w") as f:
            f.write(str(circuit))
        print("Circuit saved to circuit_60_new.stim")
    else:
        print("Circuit failed verification.")
        with open("circuit_60_new.stim", "w") as f:
            f.write(str(circuit))
        print("Circuit saved to circuit_60_new.stim (even though failed)")

if __name__ == "__main__":
    solve()
